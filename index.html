<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <!-- –û—Ç–∫–ª—é—á–∞–µ–º –∑—É–º –ø—Ä–∏ –±—ã—Å—Ç—Ä—ã—Ö —Ç–∞—á–∞—Ö –Ω–∞ –º–æ–±–∞–π–ª–µ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cat Tetris</title>
    <!-- Base mini app verification -->
    <meta name="base:app_id" content="696a892d891a0eaf2f956d4c">
    <meta name="description" content="A fun Tetris game with cat emojis - Base Mini App">
    <meta property="og:title" content="Cat Tetris">
    <meta property="og:description" content="A fun Tetris game with cat emojis">
    <meta property="og:image" content="https://cat-tetris-base.vercel.app/splash.png">
    <meta property="og:type" content="website">
    <!-- Farcaster Frame / Mini App embed meta tags -->
    <meta name="fc:frame" content="vNext">
    <meta name="fc:frame:image" content="https://cat-tetris-base.vercel.app/splash.png">
    <meta name="fc:frame:image:aspect_ratio" content="1:1">
    <meta name="fc:frame:button:1" content="Play Cat Tetris">
    <meta name="fc:frame:button:1:action" content="link">
    <meta name="fc:frame:button:1:target" content="https://cat-tetris-base.vercel.app/">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>üê± Cat Tetris üê±</h1>
        <div class="game-wrapper">
            <div class="info-panel">
                <div class="score-board">
                    <h2>–°—á—ë—Ç</h2>
                    <div id="score">0</div>
                </div>
                <div class="lines-board">
                    <h2>–õ–∏–Ω–∏–∏</h2>
                    <div id="lines">0</div>
                </div>
                <div class="level-board">
                    <h2>–£—Ä–æ–≤–µ–Ω—å</h2>
                    <div id="level">1</div>
                </div>
                <div class="controls">
                    <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
                    <p>‚Üê ‚Üí –î–≤–∏–∂–µ–Ω–∏–µ</p>
                    <p>‚Üì –£—Å–∫–æ—Ä–µ–Ω–∏–µ</p>
                    <p>‚Üë –ü–æ–≤–æ—Ä–æ—Ç</p>
                </div>
            </div>
            <canvas id="gameCanvas" width="300" height="600"></canvas>
            <div class="next-panel">
                <h2>–°–ª–µ–¥—É—é—â–∞—è</h2>
                <canvas id="nextCanvas" width="120" height="120"></canvas>
            </div>
        </div>

        <!-- Tip jar + daily tournament -->
        <div class="actions-panel" id="actionsPanel">
            <h2>Tip & Tournament</h2>
            <div class="actions-row">
                <button id="btn-tip">Tip (0.00005 ETH)</button>
                <button id="btn-enter-tournament">Enter daily tournament</button>
            </div>
            <div class="tournament-stats">
                <div><strong>Day</strong>: <span id="t-day">‚Äî</span></div>
                <div><strong>Entry fee</strong>: <span id="t-fee">‚Äî</span></div>
                <div><strong>Prize pool</strong>: <span id="t-pool">‚Äî</span></div>
                <div><strong>Best score</strong>: <span id="t-best">‚Äî</span></div>
                <div><strong>Leader</strong>: <span id="t-leader">‚Äî</span></div>
            </div>
            <div class="tx-status" id="tx-status"></div>
            <p class="actions-note">
                Tournament rule: highest score today wins the prize pool. Your score is taken from the current game score at the moment you enter.
            </p>
        </div>

        <div id="gameOver" class="game-over hidden">
            <h2>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2>
            <p>–§–∏–Ω–∞–ª—å–Ω—ã–π —Å—á—ë—Ç: <span id="finalScore">0</span></p>
            <button onclick="game.restart()">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        </div>
    </div>
    <!-- –≠–∫—Ä–∞–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ -->
    <div class="touch-controls">
        <button aria-label="–í–ª–µ–≤–æ" id="btn-left">‚Üê</button>
        <div class="touch-center">
            <button aria-label="–ü–æ–≤–µ—Ä–Ω—É—Ç—å" id="btn-rotate">‚ü≥</button>
            <button aria-label="–í–Ω–∏–∑" id="btn-down">‚Üì</button>
        </div>
        <button aria-label="–í–ø—Ä–∞–≤–æ" id="btn-right">‚Üí</button>
    </div>
    <script src="tetris.js"></script>
    <!-- MiniKit ready signal for Base preview -->
    <script id="minikit-loader" src="https://cdn.jsdelivr.net/npm/@coinbase/minikit-js@1.1.0/dist/index.umd.js" defer></script>
    <!-- Ethers for onchain tx (Tip / Tournament) -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js" defer></script>
    <script src="onchain.js" defer></script>
    <script>
      // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–∑–æ–≤ MiniKit.ready —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
      function tryMiniKitReady(maxTries = 30, delay = 200) {
        let tries = 0;
        console.log('[MiniKit] Starting ready check...');
        const timer = setInterval(() => {
          tries++;
          if (window.MiniKit && typeof window.MiniKit.ready === 'function') {
            try {
              window.MiniKit.ready();
              console.log('[MiniKit] ready() called successfully on try', tries);
              clearInterval(timer);
            } catch (e) {
              console.warn('[MiniKit] ready() error:', e);
            }
          } else {
            console.log('[MiniKit] SDK not loaded yet, try', tries);
          }
          if (tries >= maxTries) {
            console.warn('[MiniKit] Max tries reached, SDK may not be available');
            clearInterval(timer);
          }
        }, delay);
      }

      // –¢–∞–∫–∂–µ –ø—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∏–≥–Ω–∞–ª –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ postMessage (fallback)
      function sendReadySignal() {
        try {
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({ type: 'minikit:ready' }, '*');
            console.log('[MiniKit] Sent postMessage ready signal');
          }
        } catch (e) {
          console.warn('[MiniKit] postMessage error:', e);
        }
      }

      window.addEventListener('load', () => {
        tryMiniKitReady();
        sendReadySignal();
        // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ —ç–∫—Ä–∞–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
        const btnL = document.getElementById('btn-left');
        const btnR = document.getElementById('btn-right');
        const btnD = document.getElementById('btn-down');
        const btnRot = document.getElementById('btn-rotate');
        const safe = fn => () => { if (window.game && !window.game.gameOver) fn(); };
        btnL?.addEventListener('click', safe(() => window.game.movePiece(-1, 0)));
        btnR?.addEventListener('click', safe(() => window.game.movePiece(1, 0)));
        btnD?.addEventListener('click', safe(() => window.game.dropPiece()));
        btnRot?.addEventListener('click', safe(() => window.game.rotatePiece()));
      });
    </script>
</body>
</html>
